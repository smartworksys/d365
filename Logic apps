name: Infra_Deploy_$(BuildDefinitionName)_$(date:yyyyMMdd)$(rev:.r)

trigger: none

# Default pool for most stages
pool:
  name: OneMemberWinPool

parameters:
- name: environment
  displayName: 'Deployment Environment'
  type: string
  default: 'QA'
  values:
  - DEV
  - QA
  - UAT
  - PROD

- name: deploy_app_connections
  displayName: 'Deploy Logic App Connections'
  type: boolean
  default: false

- name: deploy_logicapp_workflows
  displayName: 'Deploy Logic App Workflows'
  type: boolean
  default: false

- name: update_webhooks
  displayName: 'Update Logic App Workflows Webhooks'
  type: boolean
  default: false

variables:
- ${{ if eq(parameters.environment, 'DEV') }}:
  - template: kofc-logicapp-variables/pipeline-vars-dev.yml
- ${{ if eq(parameters.environment, 'QA') }}:
  - template: kofc-logicapp-variables/pipeline-vars-test.yml
- ${{ if eq(parameters.environment, 'UAT') }}:
  - template: kofc-logicapp-variables/pipeline-vars-uat.yml
- ${{ if eq(parameters.environment, 'PROD') }}:
  - template: kofc-logicapp-variables/pipeline-vars-prod.yml

stages:
# ------------------------------
# Stage 1: Deploy CRM Connection
# ------------------------------
- stage: deploy_crm_connection
  displayName: 'Deploy CRM Connection'
  jobs:
  - job: fetch_secrets_and_deploy_connections
    displayName: 'Fetch secrets and deploy connections'
    steps:
    - task: AzureKeyVault@2
      displayName: 'Download secrets from Key Vault'
      inputs:
        azureSubscription: $(serviceConnection)
        KeyVaultName: '$(keyVaultName)'
        SecretsFilter: '*'
        RunAsPreJob: true

    - task: AzureResourceManagerTemplateDeployment@3
      displayName: 'Deploy Logic App connections ARM template'
      condition: and(succeeded(), eq('${{ parameters.deploy_app_connections }}', 'true'))
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: $(serviceConnection)
        subscriptionId: $(aspSubscriptionId)
        action: 'Create Or Update Resource Group'
        resourceGroupName: $(aspResourceGroup)
        location: $(Location)
        templateLocation: 'Linked artifact'
        csmFile: '$(System.DefaultWorkingDirectory)/kofc-logicapp-connections/logicappconnections.json'
        overrideParameters: >-
          -aspSubscriptionId $(aspSubscriptionId)
          -connections_cds_name $(dataverseConnectionName)
          -env $(env)
          -dataverseclientId $(con-crm)
          -dataverseclientSecret $(con-crm-key)
        deploymentMode: 'Incremental'

# ------------------------------
# Stage 2: Build Logic App Artifacts
# ------------------------------
- stage: build_artifacts
  displayName: 'Build Logic App Artifacts'
  jobs:
  - job: logic_app_build
    displayName: 'Build and publish logic app'
    steps:
    - task: CopyFiles@2
      displayName: 'Create project folder'
      inputs:
        SourceFolder: '$(System.DefaultWorkingDirectory)'
        Contents: |
          kofc-logicapp-workflows/**
        TargetFolder: 'project_output'

    - task: ArchiveFiles@2
      displayName: 'Archive files'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/project_output/kofc-logicapp-workflows'
        includeRootFolder: false
        archiveType: zip
        archiveFile: $(System.DefaultWorkingDirectory)/$(Build.BuildId).zip
        replaceExistingArchive: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish build artifacts'
      inputs:
        PathtoPublish: '$(System.DefaultWorkingDirectory)/$(Build.BuildId).zip'
        artifactName: 'drop'

# ------------------------------
# Stage 3: Deploy Logic App Workflows
# ------------------------------
- stage: arm_template_deploy
  displayName: 'Deploy Logic App Workflows'
  jobs:
  - job: arm_template_deploy
    displayName: 'Deploy Logic App Workflows'
    steps:
    - checkout: self

    - task: DownloadBuildArtifacts@0
      displayName: 'Download build artifacts'
      condition: and(succeeded(), eq('${{ parameters.deploy_logicapp_workflows }}', 'true'))
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(System.ArtifactsDirectory)'

    - task: AzureFunctionApp@1
      displayName: 'Deploy logic app workflows'
      condition: and(succeeded(), eq('${{ parameters.deploy_logicapp_workflows }}', 'true'))
      inputs:
        azureSubscription: $(serviceConnection)
        appType: 'functionApp'
        appName: '$(logicAppName)'
        package: '$(System.ArtifactsDirectory)/**/*.zip'

# ------------------------------
# Stage 4: Update Dataverse Webhooks
# (only created if update_webhooks == true)
# Handles:
#   - Multi-tenant Logic Apps (Microsoft.Logic/workflows)
#   - Logic Apps Standard (stateful workflows, Microsoft.Web/sites/workflows)
# ------------------------------
- ${{ if eq(parameters.update_webhooks, true) }}:
  - stage: update_webhooks
    displayName: 'Update Dataverse Webhooks'
    # Use a Microsoft-hosted agent that already has az CLI
    pool:
      vmImage: 'windows-latest'
    jobs:
    - job: enable_webhooks
      displayName: 'Re-register Dataverse Logic App triggers'
      steps:
      - checkout: self

      - task: AzureCLI@2
        displayName: 'Re-register Dataverse Logic App triggers'
        inputs:
          azureSubscription: $(serviceConnection)
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            $resourceGroup      = "$(aspResourceGroup)"
            $dataverseUrl       = "$(CRMendpointUrl)"
            $logicAppName       = "$(logicAppName)"
            $apiVersionLogic    = "2019-05-01"
            $apiVersionStandard = "2022-03-01"

            Write-Host "Using az version:"
            az --version

            # ------------------------------------------------
            # Try multi-tenant Logic Apps first (Microsoft.Logic/workflows)
            # ------------------------------------------------
            Write-Host "Searching for multi-tenant Logic App workflow named '$logicAppName' in '$resourceGroup'..."
            $workflowsJson = az resource list `
              --resource-group $resourceGroup `
              --resource-type "Microsoft.Logic/workflows" `
              --query "[?name=='$logicAppName']"

            $useStandardType = $false

            if (-not $workflowsJson -or $workflowsJson -eq "[]") {
              Write-Host "No Microsoft.Logic/workflows named '$logicAppName' found. Assuming Logic App Standard (stateful workflows)."

              # ------------------------------------------------
              # Logic Apps Standard: workflows under Microsoft.Web/sites/workflows
              # Filter by the Logic App Standard site name in the id
              # ------------------------------------------------
              $workflowsJson = az resource list `
                --resource-group $resourceGroup `
                --resource-type "Microsoft.Web/sites/workflows" `
                --query "[?contains(id, '/sites/$logicAppName/')]"

              $useStandardType = $true
            }

            if (-not $workflowsJson -or $workflowsJson -eq "[]") {
              Write-Host "No workflow resources found for '$logicAppName' in resource group '$resourceGroup'. Nothing to update."
              exit 0
            }

            $workflows = $workflowsJson | ConvertFrom-Json
            if ($workflows -isnot [System.Collections.IEnumerable]) {
              $workflows = @($workflows)
            }

            Write-Host "Found $($workflows.Count) workflow resource(s) to process."

            foreach ($wf in $workflows) {
              $wfId = $wf.id
              Write-Host "Processing workflow resource id: $wfId"

              $apiVersion = if ($useStandardType) { $apiVersionStandard } else { $apiVersionLogic }

              $wfDetailJson = az resource show --ids $wfId --api-version $apiVersion
              if (-not $wfDetailJson) {
                Write-Host "  Unable to get details for workflow id '$wfId'. Skipping."
                continue
              }

              $wfDetail   = $wfDetailJson | ConvertFrom-Json
              $definition = $wfDetail.properties.definition

              if (-not $definition) {
                Write-Host "  No 'properties.definition' present on workflow '$($wf.name)'. Skipping."
                continue
              }

              $triggers = $definition.triggers.PSObject.Properties.Name
              if (-not $triggers -or $triggers.Count -eq 0) {
                Write-Host "  No triggers found on workflow '$($wf.name)'."
                continue
              }

              foreach ($triggerName in $triggers) {
                Write-Host "  Checking trigger: $triggerName"
                $trigger = $definition.triggers.$triggerName

                if ($trigger.type -eq "ApiConnection") {
                  Write-Host "    Updating Dataverse trigger environment URL for '$triggerName'..."

                  # Path inside resource:
                  #   properties.definition.triggers.<trigger>.inputs.parameters.environment
                  $setExpression = "properties.definition.triggers.$triggerName.inputs.parameters.environment='$dataverseUrl'"

                  az resource update `
                    --ids $wfId `
                    --api-version $apiVersion `
                    --set $setExpression

                  # Enable trigger only for classic (multi-tenant) Logic Apps
                  if (-not $useStandardType) {
                    Write-Host "    Enabling trigger '$triggerName' on Logic App '$logicAppName'..."
                    az logicapp trigger enable `
                      --resource-group $resourceGroup `
                      --name $logicAppName `
                      --trigger-name $triggerName
                  }
                  else {
                    Write-Host "    (Standard) Skipping 'az logicapp trigger enable' â€“ workflows are hosted under Microsoft.Web/sites/workflows."
                  }
                }
                else {
                  Write-Host "    Skipping non-ApiConnection trigger of type '$($trigger.type)'."
                }
              }
            }

            Write-Host "Finished updating Dataverse triggers for Logic App '$logicAppName'."
