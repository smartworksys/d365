- task: AzureCLI@2
  displayName: 'Re-register Dataverse Logic App triggers'
  inputs:
    azureSubscription: $(serviceConnectionName)
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      $resourceGroup = "$(resourceGroupName)"
      $dataverseUrl  = "$(dataverseUrl)"

      Write-Host "Finding Logic Apps in RG: $resourceGroup"

      $logicApps = az logicapp list --resource-group $resourceGroup | ConvertFrom-Json

      foreach ($app in $logicApps) {
          Write-Host "Processing Logic App: $($app.name)"

          $definition = az logicapp show --resource-group $resourceGroup --name $app.name --query "definition" | ConvertFrom-Json
          $triggers = $definition.triggers.PSObject.Properties.Name

          foreach ($triggerName in $triggers) {
              Write-Host "  Checking trigger: $triggerName"

              $trigger = $definition.triggers.$triggerName

              if ($trigger.type -eq "ApiConnection") {
                  Write-Host "    Updating Dataverse trigger environment URL..."

                  az logicapp update `
                    --resource-group $resourceGroup `
                    --name $app.name `
                    --set "definition.triggers.$triggerName.inputs.parameters.environment='$dataverseUrl'"
              }
              else {
                  Write-Host "    Skipping non-Dataverse trigger."
              }
          }
      }
