<div id="recommendationsInputModal" role="dialog" class="modal fade modal-form modal-form-insert in" data-backdrop="static">
    <div class="modal-lg modal-dialog modal-accnt" style="max-width: 850px !important;">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Recommendations</h4>
                <button type="button" data-dismiss="modal" class="close">Ã—</button>
            </div>

            <div class="modal-body">
                <table style="width:100%">
                    <tr>
                        <td>
                            <label for="filterInput" id="filterInputLabel">Filter List by: </label>
                            <input type="text" placeholder="search term" id="filterInput" class="form-control" value="" style="width:500px; display:inline-block;">
                            &nbsp;
                            <button type="button" id="clearFilterBtn" class="btn action">Clear</button>
                            <button type="button" id="doFilterBtn" class="btn btn-primary action">Filter</button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div style="margin-top:15px">
                                <label for="recommendationTable">Select Recommendations:</label>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table id="recommendationTable" class="table table-bordered" style="margin-top:10px; width:100%;">
                                        <thead>
                                            <tr>
                                                <th>Select</th>
                                                <th>Category</th>
                                                <th>Recommendation Title</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% if lq_parent_ewr_program_GUID %}
                                                {% assign ewrParentProgramID = lq_parent_ewr_program_GUID %}
                                                {% fetchxml recommendations_query %}
                                                    <fetch>
                                                        <entity name="cms_ewr_recommendation">
                                                            <attribute name="cms_ewr_recommendationid" />
                                                            <attribute name="cms_recommendation_title" />
                                                            <attribute name="cms_recommendation_description" />
                                                            <attribute name="cms_related_measure_id" />
                                                            <attribute name="cms_recommendation_category_id" />
                                                            <link-entity name="cms_measurecategory" from="cms_measurecategoryid" to="cms_recommendation_category_id" link-type="inner">
                                                                <attribute name="cms_name" />
                                                            </link-entity>
                                                        </entity>
                                                    </fetch>
                                                {% endfetchxml %}

                                                {% for recommendationsIntersect in recommendations_query.results.entities %}
                                                    <tr class="recommendation-row">
                                                        <td style="width:10%;">
                                                            <input type="checkbox" name="selectedRecommendations"
                                                                   value="{{recommendationsIntersect.cms_ewr_recommendationid}}"
                                                                   data-recommendation-title="{{recommendationsIntersect.cms_recommendation_title}}">
                                                        </td>
                                                        <td class="category" style="width:20%;">{{recommendationsIntersect.cat.cms_name}}</td>
                                                        <td class="recommendation-title" style="width:30%;">{{recommendationsIntersect.cms_recommendation_title}}</td>
                                                        <td class="recommendation-description" style="width:30%;">{{recommendationsIntersect.cms_recommendation_description}}</td>
                                                    </tr>
                                                {% endfor %}
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="selectedRecommendationsList">Selected Recommendations:</label>
                            <select id="selectedRecommendationsList" class="form-control" multiple style="height: 150px;">
                                <!-- List box populated dynamically -->
                            </select>
                        </td>
                    </tr>
                    <!-- Hidden multi-select dropdown for form submission -->
                    <tr style="display:none;">
                        <td>
                            <select id="recommendationDropdown" class="form-control" multiple>
                                <!-- Dropdown dynamically updated based on selection -->
                            </select>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btn_saveRecommendation">Save Recommendations</button>
            </div>
        </div>
    </div>
</div>

<script>
    // JavaScript to handle filtering
    document.getElementById("doFilterBtn").addEventListener("click", function() {
        const filterValue = document.getElementById("filterInput").value.toLowerCase();
        const rows = document.querySelectorAll("#recommendationTable .recommendation-row");

        rows.forEach(row => {
            const category = row.querySelector(".category").textContent.toLowerCase();
            const title = row.querySelector(".recommendation-title").textContent.toLowerCase();
            row.style.display = (category.includes(filterValue) || title.includes(filterValue)) ? "" : "none";
        });
    });

    // Clear Filter
    document.getElementById("clearFilterBtn").addEventListener("click", function() {
        document.getElementById("filterInput").value = "";
        const rows = document.querySelectorAll("#recommendationTable .recommendation-row");
        rows.forEach(row => row.style.display = "");
    });

    // Update list box and dropdown based on checkbox selection
    document.querySelectorAll('input[name="selectedRecommendations"]').forEach(checkbox => {
        checkbox.addEventListener("change", function() {
            const listBox = document.getElementById("selectedRecommendationsList");
            const dropdown = document.getElementById("recommendationDropdown");
            const recommendationId = this.value;
            const recommendationTitle = this.getAttribute("data-recommendation-title");

            if (this.checked) {
                // Add to list box if checked
                const option = document.createElement("option");
                option.value = recommendationId;
                option.textContent = recommendationTitle;
                option.setAttribute("data-id", recommendationId);
                listBox.appendChild(option);

                // Add to hidden dropdown for form submission
                const dropdownOption = document.createElement("option");
                dropdownOption.value = recommendationId;
                dropdownOption.textContent = recommendationTitle;
                dropdownOption.selected = true;
                dropdownOption.setAttribute("data-id", recommendationId);
                dropdown.appendChild(dropdownOption);
            } else {
                // Remove from list box if unchecked
                const optionToRemove = listBox.querySelector(`option[data-id="${recommendationId}"]`);
                if (optionToRemove) {
                    listBox.removeChild(optionToRemove);
                }

                // Remove from dropdown
                const dropdownOptionToRemove = dropdown.querySelector(`option[data-id="${recommendationId}"]`);
                if (dropdownOptionToRemove) {
                    dropdown.removeChild(dropdownOptionToRemove);
                }
            }
        });
    });

    // Save selected recommendations
    document.getElementById("btn_saveRecommendation").addEventListener("click", function() {
        const selectedOptions = Array.from(document.getElementById("recommendationDropdown").options)
            .filter(option => option.selected)
            .map(option => ({ id: option.value, title: option.textContent }));
        
        console.log("Selected Recommendations for form submission:", selectedOptions);
    });
</script>
