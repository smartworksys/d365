// Define the Filterfunction outside the main function so that it is persistent across calls
var Filterfunction = null;

var filterProducts = function(formContext, descId, lookupFieldName, planType) {
    let expirationDate = new Date().toISOString().split('T')[0];

    var fetchXml = `
      <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
      <entity name="nfc_otdb_product">
        <attribute name="nfc_otdb_productid" />
        <attribute name="nfc_otdb_name" />
        <attribute name="createdon" />
        <order attribute="nfc_otdb_name" descending="false" />
        <filter type="and">
          <condition attribute="nfc_otdb_shortdescription" operator="eq" value="${descId}" />
          <condition attribute="statecode" operator="eq" value="0" />
          <condition attribute="nfc_otdb_productstatus" operator="eq" value="451130000" />
          <condition attribute="nfc_otdb_expirationdate" operator="gt" value="${expirationDate}" />
        </filter>
      </entity>
    </fetch>`;

    // Define the filter function only if it has not been defined already
    if (!Filterfunction) {
        Filterfunction = function() {
            formContext.getControl(lookupFieldName).addCustomFilter(fetchXml, "nfc_otdb_product");
        };
    }

    // Remove the previous preSearch handler if it exists
    formContext.getControl(lookupFieldName).removePreSearch(Filterfunction);

    // Add the custom filter using the existing or new function reference
    formContext.getControl(lookupFieldName).addPreSearch(Filterfunction);
};
