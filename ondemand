function filterAccountNumbersLookup(executionContext) {
    var formContext = executionContext.getFormContext();
    var accountTypeField = "nf1pbm_certificateaccounttype"; // Replace with your account type lookup field schema name
    var lookupFieldName = "nf1pbm_certificateaccountnumber"; // Replace with your account number lookup field schema name

    // Get the selected value of the account type lookup field
    var accountTypeValue = formContext.getAttribute(accountTypeField).getValue();
    if (accountTypeValue && accountTypeValue.length > 0) {
        var accountTypeId = accountTypeValue[0].id; // Get the GUID of the selected account type

        // Define the FetchXML to filter the lookup
        var fetchXml = `
          <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
            <entity name="nf1pbm_certificateaccountnumber">
              <attribute name="nf1pbm_certificateaccountnumberid" />
              <attribute name="nf1pbm_name" />
              <attribute name="createdon" />
              <order attribute="nf1pbm_name" descending="false" />
              <filter type="and">
                <condition attribute="nf1pbm_accounttype" operator="eq" value="${accountTypeId}" />
                <condition attribute="nf1pbm_maturityinstructionuser" operator="eq-userid" />
              </filter>
            </entity>
          </fetch>`;

        // Add the custom filter to the lookup field
        formContext.getControl(lookupFieldName).addPreSearch(function() {
            formContext.getControl(lookupFieldName).addCustomFilter(fetchXml);
        });
    }
}

// Attach the filter function to the OnLoad event and the OnChange event of the account type lookup field
function onLoad(executionContext) {
    var formContext = executionContext.getFormContext();
    var accountTypeField = "nf1pbm_certificateaccounttype"; // Replace with your account type lookup field schema name

    // Filter the lookup on form load
    filterAccountNumbersLookup(executionContext);

    // Add an OnChange event handler to the account type lookup field
    formContext.getAttribute(accountTypeField).addOnChange(filterAccountNumbersLookup);
}
