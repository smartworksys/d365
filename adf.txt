// declare this outside so both promises can close over it
let duplicateNotifId;

if (result.entities.length > 0) {
    const record   = result.entities[0];
    const recordId = record.nf1pbm_maturityinstructionsid;

    // schedule the notification and capture its ID
    Xrm.App.addGlobalNotification({
        type:            2,
        level:           2,
        message:         formatString(CONSTANTS.MESSAGES.DUPLICATE_RECORD, recordId),
        showCloseButton: true,
        action: {
            actionLabel: "View",
            eventHandler: function () {
                Xrm.Navigation.openForm({
                    entityName: CONSTANTS.ENTITY_NAMES.MATURITY_INSTRUCTIONS,
                    entityId:   recordId
                }).then(
                    function () {
                        // remove the banner
                        Xrm.App.clearGlobalNotification(duplicateNotifId);
                        // reload the page so nothing persists
                        window.location.reload();
                    },
                    function (err) {
                        console.error("openForm error", err);
                    }
                );
            }
        }
    }).then(
        function (notifId) {
            duplicateNotifId = notifId;
        },
        function (err) {
            console.error("Failed to show notification", err);
        }
    );

    makeFormReadOnly(executionContext);
    return [];
}
